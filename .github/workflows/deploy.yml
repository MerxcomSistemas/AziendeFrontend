# =============================================================================
# WORKFLOW: Build y Deploy a servidor
# =============================================================================
# Este workflow construye la aplicaci√≥n Node.js y la despliega a una VM interna.
#
# Arquitectura de conexi√≥n:
#   GitHub Actions ‚Üí Servidor Principal (SSH_HOST) ‚Üí VM (192.168.1.21)
#
# Flujo:
#   1. Checkout del repositorio
#   2. Configurar Node.js e instalar dependencias
#   3. Construir la aplicaci√≥n (npm run build)
#   4. Copiar archivos construidos al servidor principal via SCP
#   5. Desde el servidor principal, copiar a la VM interna
#
# Secrets requeridos:
#   - SSH_HOST: IP o dominio del servidor principal
#   - SSH_PORT: Puerto SSH (normalmente 22)
#   - SSH_USER: Usuario para conectarse
#   - SSH_PASSWORD: Contrase√±a del usuario
# =============================================================================

name: Build y Deploy a servidor

on:
  push:
    branches: [ "main" ]  # Se ejecuta en push a main
  workflow_dispatch:       # Permite ejecuci√≥n manual

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Descargar el c√≥digo del repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # Paso 2: Verificar secrets configurados
      - name: Verificar secrets
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ]; then echo "‚ùå SSH_HOST no configurado"; else echo "‚úì SSH_HOST configurado"; fi
          if [ -z "${{ secrets.SSH_PORT }}" ]; then echo "‚ùå SSH_PORT no configurado"; else echo "‚úì SSH_PORT configurado"; fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then echo "‚ùå SSH_USER no configurado"; else echo "‚úì SSH_USER configurado"; fi
          if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then echo "‚ùå SSH_PASSWORD no configurado"; else echo "‚úì SSH_PASSWORD configurado"; fi

      # Paso 3: Configurar Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Paso 3: Instalar dependencias de todos los proyectos
      - name: Instalar dependencias (ra√≠z)
        run: npm ci

      - name: Instalar dependencias (Host - Starterkit)
        run: npm ci
        working-directory: ./Starterkit - ts

      - name: Instalar dependencias (Editor)
        run: npm ci
        working-directory: ./AziendePlatformEditor

      # Paso 4: Construir la aplicaci√≥n (Host + Editor integrados)
      - name: Construir aplicaci√≥n
        run: npm run build

      # Paso 5: Copiar archivos construidos al servidor principal
      - name: Copiar archivos al servidor principal
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "dist/*"
          target: "/tmp/deploy"
          strip_components: 1

      # Paso 6: Copiar desde servidor principal a la VM interna
      - name: Copiar archivos a la VM interna
        uses: appleboy/ssh-action@v1.2.0
        env:
          SSH_VM_PASS: ${{ secrets.SSH_PASSWORD }}
          SSH_VM_USER: ${{ secrets.SSH_USER }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          envs: SSH_VM_PASS,SSH_VM_USER
          # =========================================================
          # SCRIPT: Copiar archivos a la VM interna (solo reemplaza)
          # =========================================================
          # Usa rsync para:
          #   - Solo copiar archivos nuevos o modificados
          #   - NO borrar archivos existentes en el servidor (.htaccess, etc.)
          #   - Mantener permisos y timestamps
          # =========================================================
          script: |
            /usr/bin/sshpass -p "$SSH_VM_PASS" rsync -avz --no-delete -e "ssh -o StrictHostKeyChecking=no" /tmp/deploy/ $SSH_VM_USER@192.168.1.21:/home/aziende/web/dev.aziende.us/public_html/
            /usr/bin/sshpass -p "$SSH_VM_PASS" ssh -o StrictHostKeyChecking=no $SSH_VM_USER@192.168.1.21 << 'EOF'
              echo "‚úì Deploy completado: $(date)"
              echo "üìÅ Archivos en public_html:"
              ls -la /home/aziende/web/dev.aziende.us/public_html/
              echo ""
              echo "üìÅ Archivos en editor/:"
              ls -la /home/aziende/web/dev.aziende.us/public_html/editor/ 2>/dev/null || echo "  (carpeta editor no existe)"
            EOF
            rm -rf /tmp/deploy