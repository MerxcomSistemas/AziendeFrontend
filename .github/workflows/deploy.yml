# =============================================================================
# WORKFLOW: Deploy carpeta dist/ a servidor
# =============================================================================
# Este workflow despliega la carpeta dist/ (ya construida) a una VM interna.
#
# Arquitectura de conexi√≥n:
#   GitHub Actions ‚Üí Servidor Principal (SSH_HOST) ‚Üí VM (192.168.1.21)
#
# Flujo:
#   1. Checkout del repositorio
#   2. Verificar que existe la carpeta dist/
#   3. Copiar archivos de dist/ al servidor principal via SCP
#   4. Desde el servidor principal, copiar a la VM interna
#
# IMPORTANTE: Debes hacer npm run build localmente y subir la carpeta dist/
#
# Secrets requeridos:
#   - SSH_HOST: IP o dominio del servidor principal
#   - SSH_PORT: Puerto SSH (normalmente 22)
#   - SSH_USER: Usuario para conectarse
#   - SSH_PASSWORD: Contrase√±a del usuario
# =============================================================================

name: Deploy a servidor

on:
  push:
    branches: [ "main" ]  # Se ejecuta en push a main
  workflow_dispatch:       # Permite ejecuci√≥n manual

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Descargar el c√≥digo del repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # Paso 2: Verificar secrets configurados
      - name: Verificar secrets
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ]; then echo "‚ùå SSH_HOST no configurado"; else echo "‚úì SSH_HOST configurado"; fi
          if [ -z "${{ secrets.SSH_PORT }}" ]; then echo "‚ùå SSH_PORT no configurado"; else echo "‚úì SSH_PORT configurado"; fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then echo "‚ùå SSH_USER no configurado"; else echo "‚úì SSH_USER configurado"; fi
          if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then echo "‚ùå SSH_PASSWORD no configurado"; else echo "‚úì SSH_PASSWORD configurado"; fi

      # Paso 3: Verificar que existe la carpeta dist/
      - name: Verificar carpeta dist/
        run: |
          if [ -d "dist" ]; then
            echo "‚úì Carpeta dist/ encontrada"
            echo "üìÅ Contenido:"
            ls -la dist/
          else
            echo "‚ùå ERROR: La carpeta dist/ no existe"
            echo "Por favor, ejecuta 'npm run build' localmente y sube la carpeta dist/ al repositorio"
            exit 1
          fi

      # Paso 4: Copiar archivos de dist/ al servidor principal
      - name: Copiar archivos al servidor principal
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "dist/*"
          target: "/tmp/deploy"
          strip_components: 1

      # Paso 5: Copiar desde servidor principal a la VM interna
      - name: Copiar archivos a la VM interna
        uses: appleboy/ssh-action@v1.2.0
        env:
          SSH_VM_PASS: ${{ secrets.SSH_PASSWORD }}
          SSH_VM_USER: ${{ secrets.SSH_USER }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          envs: SSH_VM_PASS,SSH_VM_USER
          # =========================================================
          # SCRIPT: Copiar archivos a la VM interna (solo reemplaza)
          # =========================================================
          # Usa rsync para:
          #   - Solo copiar archivos nuevos o modificados
          #   - NO borrar archivos existentes en el servidor (por defecto)
          #   - Mantener permisos y timestamps
          # =========================================================
          script: |
            echo "üì¶ Verificando archivos en /tmp/deploy..."
            ls -la /tmp/deploy/
            echo ""
            echo "üöÄ Copiando archivos a la VM interna..."
            /usr/bin/sshpass -p "$SSH_VM_PASS" rsync -avz -e "ssh -o StrictHostKeyChecking=no" /tmp/deploy/ $SSH_VM_USER@192.168.1.21:/home/aziende/web/dev.aziende.us/public_html/
            echo ""
            echo "‚úÖ Verificando deploy en VM..."
            /usr/bin/sshpass -p "$SSH_VM_PASS" ssh -o StrictHostKeyChecking=no $SSH_VM_USER@192.168.1.21 << 'EOF'
              echo "‚úì Deploy completado: $(date)"
              echo ""
              echo "üìÅ Archivos en public_html:"
              ls -la /home/aziende/web/dev.aziende.us/public_html/
              echo ""
              echo "üìÅ Archivos en assets/:"
              ls -la /home/aziende/web/dev.aziende.us/public_html/assets/ | head -20
              echo ""
              echo "üìÅ Archivos en editor/:"
              ls -la /home/aziende/web/dev.aziende.us/public_html/editor/ 2>/dev/null || echo "  (carpeta editor no existe)"
            EOF
            rm -rf /tmp/deploy
