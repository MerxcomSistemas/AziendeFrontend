# =============================================================================
# WORKFLOW: Build y Deploy a servidor
# =============================================================================
# Este workflow construye la aplicación Node.js y la despliega a una VM interna.
#
# Arquitectura de conexión:
#   GitHub Actions → Servidor Principal (SSH_HOST) → VM (192.168.1.21)
#
# Flujo:
#   1. Checkout del repositorio
#   2. Configurar Node.js e instalar dependencias
#   3. Construir la aplicación (npm run build)
#   4. Copiar archivos construidos al servidor principal via SCP
#   5. Desde el servidor principal, copiar a la VM interna
#
# Secrets requeridos:
#   - SSH_HOST: IP o dominio del servidor principal
#   - SSH_PORT: Puerto SSH (normalmente 22)
#   - SSH_USER: Usuario para conectarse
#   - SSH_PASSWORD: Contraseña del usuario
# =============================================================================

name: Build y Deploy a servidor

on:
  push:
    branches: [ "main" ]  # Se ejecuta en push a main
  workflow_dispatch:       # Permite ejecución manual

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Paso 1: Descargar el código del repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # Paso 2: Verificar secrets configurados
      - name: Verificar secrets
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ]; then echo "❌ SSH_HOST no configurado"; else echo "✓ SSH_HOST configurado"; fi
          if [ -z "${{ secrets.SSH_PORT }}" ]; then echo "❌ SSH_PORT no configurado"; else echo "✓ SSH_PORT configurado"; fi
          if [ -z "${{ secrets.SSH_USER }}" ]; then echo "❌ SSH_USER no configurado"; else echo "✓ SSH_USER configurado"; fi
          if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then echo "❌ SSH_PASSWORD no configurado"; else echo "✓ SSH_PASSWORD configurado"; fi

      # Paso 3: Configurar Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Paso 3: Instalar dependencias de todos los proyectos
      - name: Instalar dependencias (raíz)
        run: npm ci

      - name: Instalar dependencias (Host - Starterkit)
        run: npm ci
        working-directory: ./Starterkit - ts

      - name: Instalar dependencias (Editor)
        run: npm ci
        working-directory: ./AziendePlatformEditor

      # Paso 4: Construir la aplicación (Host + Editor integrados)
      - name: Construir aplicación
        run: npm run build

      # Paso 5: Copiar archivos construidos al servidor principal
      - name: Copiar archivos al servidor principal
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "dist/*"
          target: "/tmp/deploy"
          strip_components: 1

      # Paso 6: Copiar desde servidor principal a la VM interna
      - name: Copiar archivos a la VM interna
        uses: appleboy/ssh-action@v1.2.0
        env:
          SSH_VM_PASS: ${{ secrets.SSH_PASSWORD }}
          SSH_VM_USER: ${{ secrets.SSH_USER }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          envs: SSH_VM_PASS,SSH_VM_USER
          # =========================================================
          # SCRIPT: Copiar archivos a la VM interna
          # =========================================================
          # PASO 6A: sshpass + scp → Copiar archivos construidos a la VM
          #   - sshpass: envía contraseña automáticamente
          #   - scp -r: copia recursiva de archivos
          #   - /tmp/deploy/* → origen (servidor principal)
          #   - usuario@ip:/ruta → destino (VM)
          #
          # PASO 6B: sshpass + ssh + heredoc → Verificar deploy
          #   - Conecta a la VM y ejecuta comandos
          #   - Muestra fecha y lista archivos
          #
          # PASO 6C: rm -rf → Limpia archivos temporales
          # =========================================================
          script: |
            /usr/bin/sshpass -p "$SSH_VM_PASS" scp -o StrictHostKeyChecking=no -r /tmp/deploy/* $SSH_VM_USER@192.168.1.21:/home/aziende/web/dev.aziende.us/public_html/
            /usr/bin/sshpass -p "$SSH_VM_PASS" ssh -o StrictHostKeyChecking=no $SSH_VM_USER@192.168.1.21 << 'EOF'
              echo "✓ Deploy completado: $(date)"
              ls -la /home/aziende/web/dev.aziende.us/public_html/
            EOF
            rm -rf /tmp/deploy